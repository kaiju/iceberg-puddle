---
services:
  rest:
    image: apache/iceberg-rest-fixture
    depends_on:
      bootstrap:
        condition: service_completed_successfully
    ports:
      - "8181:8181"
    volumes:
      - secrets:/run/secrets
      - rest-data:/data
    environment:
      - CATALOG_WAREHOUSE=s3://datastore
      - CATALOG_IO__IMPL=org.apache.iceberg.aws.s3.S3FileIO
      - CATALOG_S3_ENDPOINT=http://garage:3900
      - CATALOG_S3_PATH__STYLE__ACCESS=true
      - CATALOG_URI=jdbc:sqlite:/data/iceberg_catalog.db
      # Does Garage seriously not support aws chunked encoding? Huh.
      - JAVA_TOOL_OPTIONS=-Daws.requestChecksumCalculation=WHEN_REQUIRED -Daws.responseChecksumValidation=WHEN_REQUIRED
    entrypoint: "/bin/sh"
    command:
      - "-c"
      - |-
        export AWS_ACCESS_KEY_ID="$(cat /run/secrets/aws-access-key-id)"
        export AWS_SECRET_ACCESS_KEY="$(cat /run/secrets/aws-secret-access-key)"
        export AWS_REGION=garage
        java -jar iceberg-rest-adapter.jar

  garage:
    image: &garage-image dxflrs/garage:v2.1.0
    environment:
      RUST_LOG: "garage_net::netapp=warn,garage_api_admin::api_server=warn" # no more healthcheck logspam
    volumes: &garage-volumes
      - garage-data:/garage-data
      - ./config/garage.toml:/etc/garage.toml
      - secrets:/run/secrets
    healthcheck:
      test: ["CMD", "/garage", "status"]
      interval: 1s
      timeout: 10s
      retries: 3
      start_period: 3s
    ports:
      - "3900:3900"
      - "3901:3901"
      - "3902:3902"
      - "3903:3903"

  bootstrap:
    build:
      context: images/bootstrap/
      dockerfile: Containerfile
    volumes: *garage-volumes
    restart: "no"
    depends_on:
      garage:
        condition: service_healthy
    entrypoint: "/bin/sh"
    command:
      - "-c"
      - |-
        #!/usr/bin/env sh

        GARAGE_RPC_HOST="$(/garage node id -q)"
        CLUSTER_STATUS="$(/garage json-api GetClusterStatus)"
        NODE_ID="$(echo "$$CLUSTER_STATUS" | jq -r .'nodes[0].id')"

        # If we haven't already applied a layout, let's do that
        LAYOUT_VERSION="$(echo "$$CLUSTER_STATUS" | jq -r '.layoutVersion')"
        if [ "$$LAYOUT_VERSION" -eq "0" ]; then
            /garage layout assign -z dc1 -c 1G "$${NODE_ID}"
            /garage layout apply --version 1
        fi

        # Create our S3 bucket if we haven't already
        if ! /garage bucket info datastore > /dev/null; then
            /garage bucket create datastore
        fi

        # Create our access key if we haven't already
        if ! /garage key info storage-user > /dev/null; then
            /garage key create storage-user
        fi

        # Give our access key ownership over the bucket
        /garage bucket allow --read --write --owner datastore --key storage-user

        KEY_INFO="$(/garage json-api GetKeyInfo '{"search": "storage-user", "showSecretKey": true}')"

        echo "$(echo "$$KEY_INFO" | jq -r '.accessKeyId')" > /run/secrets/aws-access-key-id
        echo "$(echo "$$KEY_INFO" | jq -r '.secretAccessKey')" > /run/secrets/aws-secret-access-key

        cat <<EOF > /run/secrets/awscli.env
        export AWS_ACCESS_KEY_ID=$(cat /run/secrets/aws-access-key-id)
        export AWS_SECRET_ACCESS_KEY=$(cat /run/secrets/aws-secret-access-key)
        export AWS_DEFAULT_REGION=garage
        export AWS_ENDPOINT_URL=http://localhost:3900
        EOF

        cat <<EOF > /run/secrets/duckdb.sql
        INSTALL iceberg;
        LOAD iceberg;

        -- Set up S3 access
        CREATE SECRET s3 (
            TYPE s3,
            PROVIDER config,
            KEY_ID '$(cat /run/secrets/aws-access-key-id)',
            SECRET '$(cat /run/secrets/aws-secret-access-key)',
            REGION 'garage',
            ENDPOINT 'localhost:3900',
            URL_STYLE 'path',
            USE_SSL 'false'
        );

        -- Set up catalog
        ATTACH 'catalog' AS iceberg_catalog (
            TYPE iceberg,
            ENDPOINT 'http://localhost:8181',
            AUTHORIZATION_TYPE 'none'
        );
        EOF

        cat <<EOF > /run/secrets/.pyiceberg.yaml
        ---
        catalog:
          default:
            uri: http://locahost:8181
            s3.endpoint: http://localhost:3900
            s3.access-key-id: $(cat /run/secrets/aws-access-key-id)
            s3.secret-access-key: $(cat /run/secrets/aws-secret-access-key)
            s3.path-style-access: true
            s3.region: garage
        EOF

        echo "-----------------------------------------"
        echo "ðŸŽ‰ GARAGE BOOTSTRAP COMPLETE"
        echo "-----------------------------------------"

        echo "Access your object storage with the following config:"
        cat /run/secrets/awscli.env

volumes:
  secrets:
  rest-data:
  garage-data:
